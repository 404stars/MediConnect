<app-navbar></app-navbar>
<div class="fondo-pedirhora">
  <div class="container">
    <div class="card card-pedirhora sombra p-5">
      <h2 class="text-center mb-5">Pedir Hora Médica</h2>
      <div class="mb-4" *ngIf="paso < 5">
        <div class="d-flex justify-content-between">
          <div class="paso-indicador" [class.activo]="paso >= 1" [class.completado]="paso > 1">
            <span class="numero">1</span>
            <span class="texto">Especialidad</span>
          </div>
          <div class="paso-indicador" [class.activo]="paso >= 2" [class.completado]="paso > 2">
            <span class="numero">2</span>
            <span class="texto">Profesional</span>
          </div>
          <div class="paso-indicador" [class.activo]="paso >= 3" [class.completado]="paso > 3">
            <span class="numero">3</span>
            <span class="texto">Horario</span>
          </div>
          <div class="paso-indicador" [class.activo]="paso >= 4" [class.completado]="paso > 4">
            <span class="numero">4</span>
            <span class="texto">Confirmar</span>
          </div>
        </div>
      </div>
      <div *ngIf="message" [class]="'alert alert-' + (message.includes('[ERROR]') ? 'danger' : message.includes('[WARNING]') ? 'warning' : 'success')">
        {{ message.replace('[SUCCESS] ', '').replace('[ERROR] ', '').replace('[WARNING] ', '') }}
      </div>
            <div *ngIf="isLoading" class="text-center mb-4">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
      </div>
      <div *ngIf="paso === 1">
        <div class="mb-4">
          <label class="form-label fw-bold">Seleccionar Especialidad</label>
          <select class="form-select campo" [(ngModel)]="seleccionEspecialidad" name="especialidad">
            <option [value]="null">-- Selecciona una especialidad --</option>
            <option [value]="esp.id_especialidad" *ngFor="let esp of especialidades">
              {{ esp.nombre }}
            </option>
          </select>
        </div>
        <div class="text-center">
          <button type="button" class="btn btn-azul px-5 py-2" 
                  [disabled]="!seleccionEspecialidad" 
                  (click)="seleccionarEspecialidad()">
            Siguiente
          </button>
        </div>
      </div>
      <div *ngIf="paso === 2 && !isLoading">
        <div class="mb-4">
          <label class="form-label fw-bold">Seleccionar Profesional - {{ getEspecialidadSeleccionada()?.nombre }}</label>
          <select class="form-select campo" [(ngModel)]="seleccionProfesional" name="profesional">
            <option [value]="null">-- Selecciona un profesional --</option>
            <option [value]="prof.id_profesional" *ngFor="let prof of profesionales">
              {{ prof.nombre_completo }}
            </option>
          </select>
        </div>
        <div class="text-center">
          <button type="button" class="btn btn-secondary me-3" (click)="volver()">
            Volver
          </button>
          <button type="button" class="btn btn-azul px-5 py-2" 
                  [disabled]="!seleccionProfesional" 
                  (click)="seleccionarProfesional()">
            Siguiente
          </button>
        </div>
      </div>
      <div *ngIf="paso === 3 && !isLoading">
        <div class="mb-4">
          <label class="form-label fw-bold">Selecciona una Fecha - {{ getProfesionalSeleccionado()?.nombre_completo }}</label>
          <div class="mb-4" *ngIf="fechasDisponibles.length > 0">
            <h6 class="mb-3">Fechas disponibles:</h6>
            <div class="row g-2">
              <div class="col-6 col-md-4 col-lg-3" *ngFor="let fecha of fechasDisponibles">
                <button 
                  type="button"
                  class="btn w-100 py-3"
                  [class.btn-primary]="fechaSeleccionada === fecha"
                  [class.btn-outline-primary]="fechaSeleccionada !== fecha"
                  (click)="seleccionarFecha(fecha)">
                  <i class="bi bi-calendar3 d-block fs-4 mb-1"></i>
                  <small class="d-block">{{ formatearFechaCalendario(fecha) }}</small>
                </button>
              </div>
            </div>
          </div>
          <div *ngIf="fechaSeleccionada" class="mt-2">
            <h6 class="mb-3">Horarios disponibles para {{ fechaSeleccionada }}:</h6>
            <div class="row" *ngIf="bloquesFiltradosPorFecha.length > 0">
              <div class="col-md-6 col-lg-4 mb-3" *ngFor="let bloque of bloquesFiltradosPorFecha; trackBy: trackBloque">
                <div class="card horario-card" 
                     *ngIf="bloque && bloque.id_bloque"
                     [class.selected]="seleccionBloque === bloque.id_bloque"
                     (click)="seleccionarHorario(bloque.id_bloque)"
                     (dblclick)="$event.stopPropagation()">
                  <div class="card-body text-center">
                    <div class="h5 text-primary mb-2">
                      <i class="bi bi-clock"></i>
                      {{ bloque.hora_inicio }} - {{ bloque.hora_fin }}
                    </div>
                    <small class="text-muted">{{ bloque.especialidad }}</small>
                    <div *ngIf="seleccionBloque === bloque.id_bloque" class="mt-2">
                      <i class="bi bi-check-circle-fill text-success"></i>
                      <small class="text-success ms-1">Seleccionado</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="fechasDisponibles.length === 0" class="text-center text-muted py-4">
            <i class="bi bi-calendar-x fs-1 d-block mb-2"></i>
            No hay horarios disponibles para este profesional
          </div>
        </div>
        <div *ngIf="seleccionBloque" class="alert alert-info mt-3">
          <h6 class="mb-2"><i class="bi bi-calendar-check me-2"></i>Horario Seleccionado:</h6>
          <div class="row">
            <div class="col-md-6">
              <strong>Fecha:</strong> {{ getBloqueSeleccionado()?.fecha }}
            </div>
            <div class="col-md-6">
              <strong>Horario:</strong> {{ getBloqueSeleccionado()?.hora_inicio }} - {{ getBloqueSeleccionado()?.hora_fin }}
            </div>
          </div>
        </div>
        <div class="text-center mt-2">
          <button type="button" class="btn btn-secondary me-3" (click)="volver()">
            Volver
          </button>
          <button type="button" class="btn btn-azul btn-siguiente-horario px-5 py-2" 
                  [disabled]="!seleccionBloque" 
                  (click)="seleccionarBloque()">
            Siguiente
          </button>
        </div>
      </div>
      <div *ngIf="paso === 4 && !isLoading">
        <div class="mb-4">
          <h5 class="fw-bold mb-4">
            <i class="bi bi-check-circle text-success me-2"></i>
            Confirmar Datos de la Cita
          </h5>
          <div class="card border-primary">
            <div class="card-header bg-primary text-white">
              <h6 class="mb-0"><i class="bi bi-calendar-check me-2"></i>Resumen de tu Cita</h6>
            </div>
            <div class="card-body">
              <div class="row mb-3">
                <div class="col-md-6">
                  <div class="d-flex align-items-start">
                    <i class="bi bi-hospital text-primary me-2 mt-1"></i>
                    <div>
                      <small class="text-muted d-block">Especialidad</small>
                      <strong>{{ getEspecialidadSeleccionada()?.nombre || 'No disponible' }}</strong>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="d-flex align-items-start">
                    <i class="bi bi-person-badge text-primary me-2 mt-1"></i>
                    <div>
                      <small class="text-muted d-block">Profesional</small>
                      <strong>{{ getProfesionalSeleccionado()?.nombre_completo || 'No disponible' }}</strong>
                    </div>
                  </div>
                </div>
              </div>
              <hr>
              <div class="row">
                <div class="col-md-6">
                  <div class="d-flex align-items-start">
                    <i class="bi bi-calendar3 text-primary me-2 mt-1"></i>
                    <div>
                      <small class="text-muted d-block">Fecha</small>
                      <strong>{{ getBloqueSeleccionado()?.fecha || 'No disponible' }}</strong>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="d-flex align-items-start">
                    <i class="bi bi-clock text-primary me-2 mt-1"></i>
                    <div>
                      <small class="text-muted d-block">Horario</small>
                      <strong>{{ getBloqueSeleccionado()?.hora_inicio }} - {{ getBloqueSeleccionado()?.hora_fin }}</strong>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="mb-4">
          <label class="form-label fw-bold">Motivo de Consulta (Opcional)</label>
          <textarea class="form-control campo" 
                    [(ngModel)]="motivoConsulta" 
                    name="motivo"
                    rows="3" 
                    placeholder="Describe brevemente el motivo de tu consulta..."></textarea>
        </div>
        <div class="text-center">
          <button type="button" class="btn btn-secondary me-3" 
                  [disabled]="isLoading" 
                  (click)="volver()">
            Volver
          </button>
          <button type="button" class="btn btn-success px-5 py-2" 
                  [disabled]="isLoading"
                  (click)="confirmar()">
            <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
            {{ isLoading ? 'Agendando...' : 'Confirmar Cita' }}
          </button>
        </div>
      </div>
      <div *ngIf="paso === 5 && citaConfirmada">
        <div class="text-center py-5">
          <i class="bi bi-check-circle-fill text-success" style="font-size: 5rem;"></i>
          <h3 class="mb-3">¡Cita Agendada Exitosamente!</h3>
          <div class="alert alert-success mx-auto" style="max-width: 650px;">
            <p class="mb-0"><i class="bi bi-envelope-check me-2"></i>Se ha enviado un correo de confirmación a su email con los detalles de su cita.</p>
          </div>
          <div class="card border-success mx-auto mt-2" style="max-width: 650px;">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0"><i class="bi bi-calendar-check me-2"></i>Detalles de tu Cita</h5>
            </div>
            <div class="card-body">
              <div class="row mb-3">
                <div class="col-md-6">
                  <div class="d-flex align-items-start mb-3">
                    <i class="bi bi-hospital text-success me-2 mt-1 fs-5"></i>
                    <div>
                      <small class="text-muted d-block">Especialidad</small>
                      <strong class="fs-6">{{ getEspecialidadSeleccionada()?.nombre || 'No disponible' }}</strong>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="d-flex align-items-start mb-3">
                    <i class="bi bi-person-badge text-success me-2 mt-1 fs-5"></i>
                    <div>
                      <small class="text-muted d-block">Profesional</small>
                      <strong class="fs-6">{{ getProfesionalSeleccionado()?.nombre_completo || 'No disponible' }}</strong>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div class="d-flex align-items-start">
                    <i class="bi bi-calendar3 text-success me-2 mt-1 fs-5"></i>
                    <div>
                      <small class="text-muted d-block">Fecha</small>
                      <strong class="fs-6">{{ getBloqueSeleccionado()?.fecha }}</strong>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="d-flex align-items-start">
                    <i class="bi bi-clock text-success me-2 mt-1 fs-5"></i>
                    <div>
                      <small class="text-muted d-block">Horario</small>
                      <strong class="fs-6">{{ getBloqueSeleccionado()?.hora_inicio }} - {{ getBloqueSeleccionado()?.hora_fin }}</strong>
                    </div>
                  </div>
                </div>
              </div>
              <div *ngIf="motivoConsulta" class="mt-3 pt-3 border-top">
                <div class="d-flex align-items-start">
                  <i class="bi bi-card-text text-success me-2 mt-1 fs-5"></i>
                  <div class="w-100">
                    <small class="text-muted d-block">Motivo de Consulta</small>
                    <p class="mb-0">{{ motivoConsulta }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="mt-2">
            <button type="button" class="btn btn-success btn-lg px-5" (click)="finalizarYVolver()">
              <i class="bi bi-check2-circle me-2"></i> Finalizar
            </button>
          </div>
        </div>
      </div>
      <div class="text-center mt-2" *ngIf="paso > 1 && paso < 5 && !isLoading">
        <button type="button" class="btn btn-outline-secondary" (click)="reiniciar()">
          Empezar de Nuevo
        </button>
      </div>
    </div>
  </div>
</div>